## Make Building C as Simple as Pie

Mekpie is an opinionated build system for small scale C projects. The core premise of Mekpie is that you should not be spending time worrying about Make files, compiler arguments, or build times, when working on a small C project. By enforcing a simple directory structure and always providing a clean build, Mekpie saves you time and effort. For added convenience Mekpie takes notes from tools like [Rust's cargo](https://doc.rust-lang.org/cargo/guide/index.html) and [Node's npm](https://www.npmjs.com/) and provides options for building, running, cleaning, and testing your current project.

Mekpie is a small-scale project and is not supposed to replace tools like [CMake](https://cmake.org/) or provide any sort of package management capabilities. Use Mekpie when the alternative is a shoddy Make file or manually compiling.

### Installing

*Coming soon*

Mekpie is a python package. Use pip to install it!
```bash
$ pip install mekpie
```

### Getting Started

Create a new project by running
```bash
$ mekpie new "project-name"
project-name created successfully!
```

Then navigate to the project directory and run
```bash
$ mekpie run
Project successfully cleaned.
Project successfully built.
Hello, World!
```

That's it!

### Philosophy

Mekpie is built for the IDE free lifestyle. These days I do most of my development in [VSCode](https://code.visualstudio.com/) regardless of language. As a consequence, I am often writing small scripts to build my projects. Mekpie evolved from a python script I used in place of a Make file for my c projects. Rather than continuing to rewrite the script for every new project I decided to package this functionality together. Mekpie emphasizes simplicity and correctness over performance. Unlike most c build tools, which focus a great deal of effort on partial compilation, Mekpie recompiles the entire project from scratch every time you build, run, or test. This means that code is always fresh, and you will never have to run `mekpie clean` (though you still can if you want to remove the executables). For small programs the overhead of starting up python will be comparatively slower than the actual compilation times, so I believe this approach is a suitable one for many projects.

### Creating a Project

Mekpie provides two commands for creating a project. `mekpie new` will attempt to create a new project as a subdirectory of your current location. You will have to provide Mekpie a name for your project. This name will be used as the name for the directory as well as the main `.c` file (don't worry you can change that later).

Alternatively, you can use the `mekpie init` command to create a new project. In this case Mekpie will use the name of the current directory as the project name and setup the project in your current location. 

### Project Structure

When you create a project using either `new` or `init` the following directory structure will be generated.
```txt
project/
    target/
    includes/
    src/
        project-name.c
    tests/
    mek.py
```

The first folder generated by Mekpie, `target/`, is used to store the debug and release binaries generated for your program.

The `includes/` folder is automatically included as an includes directory to your compiler, so you can place any header files you want included in this directory. You can also place subdirectories within `includes/`.

The `src/` folder should contain all your `.c` files. Like `includes/` you can use subdirectories within. By default, a main file will be generated by Mekpie with a simple Hello World program to help you ensure everything is working correctly.

The `tests/` folder should contain all your test files. Jump [here](#testing) to find out more about tests.

The final file created by Mekpie is `mek.py` which is a small python file that allows you to configure Mekpie.

### Configuration

Configuration of Mekpie is done through the python file `mek.py` in the root of your project directory. Mekpie will autogenerate a file like the following when you first create a project.

```python
# This is a standard configuration file for mekpie

name = 'test' 
main = 'test.c'
libs = []
cc = 'gcc/clang'
cmd = 'clang'
dbg = 'lldb'
flags = ['-Wall']
override_debug_flags = None
override_release_flags = None

if options.release:
    pass # this code will only run for release builds
else:
    pass # this code will only run for debug builds
```

As shown at the bottom of the configuration file, the command line options for the current build command will be provided to your configuration anytime it is read. This allows you to easily change your configuration depending on the build. In addition to release, the options object also provides `options.quiet`, `options.verbose`, and `options.developer` which correspond to their respective command line flags.

The following table describes each option in detail.

| Option | Default | Description |
|--------|---------|-------------|
| `name` | `<projectname>` | This is a default identifier for your project. |
| `main` | `<projectname>.c` | This should be the entry point for your main program. By default, it will point at the c file auto-generated by Mekpie. |
| `libs` | `[]` | Add any libraries you want linked with your project here. For instance, if you wanted to include the c math library you would change libs to `['m']`. |
| `cc` | `'gcc/clang'` | The c compiler configuration. Currently the only supported compiler is gcc and clang. In the future we may support more configurations.
|`cmd` | *auto-detected* | The command on the command line that corresponds to your c compiler. By default, mekpie will try to auto-detect this. |
| `dbg` | *auto-detected* | The command on the command line used to start your desired debugger. By default, mekpie will try to auto-detect this. |
| `flags` | `[]` | These flags will be passed to the compiler whenever a file is compiled. For instance, to always produce verbose output from the compiler, flags could be changed to `[-v]`. |
| `override_debug_flags` | `None` | If this option is replaced with a list of strings, it will replace the c compiler configuration's choice of flags for debug builds. |
| `override_release_flags` | `None` | If this option is replaced with a list of strings, it will replace the c compiler configuration's choice of flags for release builds. |

### Running

Typically, you will skip running `mekpie build` when running your program, as building happens automatically for `mekpie run`, `mekpie debug`, and `mekpie test`. `mekpie run` will build and then execute the main file specified by your project [configuration](#configuration). You can specify a release build using `--release` or `-r`. You can provide program arguments to your main program by separating arguments to mekpie with `--`. Everything after this symbol will be passed to your program, rather than Mekpie. For example

```bash
$ mekpie --release run -- ./some-path --flag 42
```

Use `mekpie debug` if you want to start your program in your configured debugger. The usage of `mekpie test` is broken down in the next section.

### Testing

Mekpie provides simple facilities for testing your code. Add a test by placing a `.c` file, with a main function, in `tests/`. For example, if you created a test file like the following and placed it in a file named `project-tests.c`

```c
void main() {
    test_one();
    test_two();
    test_three();
    ...
}

void test_one() {
    assert ...
}
```

You could run those tests with either of the following commands

```bash
$ mekpie test
$ mekpie test project-tests
```

You can provide any number of test names to the test command. All of these tests will be run. Alternatively, providing no test names will simply run all of the tests. Test files are compiled just like your program's main file, meaning they have access to all of your project's header files.

### Commands

Note that in usage examples flags are provided before the command, however flags are not required to appear before a command unless that command takes an arbitrary number of arguments, such as `mekpie test` which accepts any number of test names. 

#### `new`

Creates a new project in a subdirectory of the provided name. The command will fail if the subdirectory already exists. If you want to initialize Mekpie in an already created directory us `mekpie init` instead. 

This command will create all of the necessary files to use `mekpie run` to build and run a simple Hello World program in c.

Usage
```bash
$ mekpie [--changedir|--developer] new <project-name>
```

#### `init`

Behaves just like `mekpie new` accept initializes the project in the current directory. The current directory's name will be used as the project name.

Usage
```bash
$ mekpie [--changedir|--developer] init
```

#### `test`

When no test names are provided this command will run all files contained in `tests/`. If test names are provided only those test files whose names are included will be run. Any number of test names can be provided.

Usage
```bash
$ mekpie [--release|--quiet|--changedir|--developer] test [test-names...]
```

#### `clean`

Removes all existing executables from `target/`.

Usage
```bash
$ mekpie [--changedir|--developer] clean
```

#### `build`

Attempts to create an executable in `target/`.

Usage
```bash
$ mekpie [--release|--quiet|--changedir|--developer] build
```

#### `run`

Cleans, builds, and then runs the main file of the project. The main file of a project is specified in the project configuration.

Usage
```bash
$ mekpie [--release|--quiet|--changedir|--developer] run
```

#### `debug`

Cleans, builds, and then runs the debugger on the main file of the project.

Usage
```bash
$ mekpie [--quiet|--changedir|--developer] debug
```

### Options

The following table describes Mekpie's command line options.

| Option  | Flag | Description |
|---------|------|-------------|
| `help` | `-h` | Displays a command line usage help message. |
| `version` | `-V` | Prints version info and exits. |
| `verbose` | `-v` | Provides the verbose flag to the c compiler when building your project. |
| `quiet` | `-q` | This will suppress information from being printed to stdout. |
| `release` | `-r` | When applicable the build will be done with the release configuration. By default, builds are done with the debug configuration. |
| `developer` | `-d` | Runs Mekpie in developer mode. This produces additional logging and stack traces on errors. |
| `changedir` | `-c` | Runs Mekpie command as if it had been invoked from the provided directory. Provide a path immediately after this flag. |   

### Contact

Feel free to send be bug reports or feature requests. If you are interested in my other work, checkout my [website](https://ejrbuss.net).

Email ejrbuss@gmail.com

